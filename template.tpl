___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Bloomreach Discovery Event API",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAA2FBMVEX/1QD///8AKED/0wD/1wAAEkLkwRH/2wD/2QD/2gAAFUIAGEL/3QDCqBwAHkEAJkD//vj//O4AI0H/+eMAHUH/7ar/2zv/+d7/6pv/6ZIAIEH/2B7/9tX/+d8AJEF6cy7/4mv/2TC2oR0AAEQADkL/3lj/77P/8bwACUP/4nH/9MoAF0L+7KNhYTKvmiL/6IzuygYNLj5uajHStBaRhCk5RTn+8sTApxwZMzwuPzugjidNUzfzzQVTVzXMrxrlww6nkySJfSxqZzJASjgsPTuBeC4iNzyXiCg3U/ClAAAMAElEQVR4nO2de1viOBSHCw1QoMpVkItapDLgzLgq4+oq3nBdv/832oKDTdKkTZuTpjj+nmfmjwJtX5OcnJycJEbus8vQ/QLK9UW4/foi3H59EW6/UiSsN1rd7nA47HZbjXp6j1VOWG+cTnqzk4FhkjIGJ7O/JqfqWVUSNk73ndGazOBo9dHI2f+7ofAtVBEe7DmDEDSaEzl7XUVvooKwMXGQIByOiZyJirIEJ+z2OrHpfMpOD7woYQlbvUFivA3koHcA+k6AhPW95KVHleQeoIUFIxzOQPA2kLMh1IsBEX7rwOH9huxMYF4NgrD+w4DmWzMaPwBeDoJwXwnfO+N+BgjVlB8goyThRCnfmhHtaSQcjlTzrRlHp5oIG04afGvGEwl3Ljnhj7T41ozJzWpSwoNUKiiG2EnqyyUk7KXLt2bspUjYAvdghBBHrbQIJzr41oxJOo4EhKmZUAaikwJha6AP0EMcxK6pcQm/6eRbM35TS6jBhgYQY9rUeIQam6CvmI0xDmFdSycRlNmJE+SIQdgY6Eb70CCGnypO2NKNRUjchxMm7OpmoiQcVxUlHOomomWKBuMECTMH6EkQUYywmw0jSsoUq6hChNkyMr6EPDgRwoZuEq5EOg0Bwnp2+kFaA4GuX4Cwo5sjRB0Iwkz4ojwJ+KiRhBkYTYQpeqQRRah9PBilyPFiBGEr64AeYkSfEUGYXTPqayBDmGkrs1GEtQkl1BY2jCczdLY4jHALGuG7QptiGOFI95sLK6zjDyHMeE+IK6xX5BMebA+gh8iPavAJs+yOBjWKTyg1AYosQggMhCv+FCqPsCEFuDg7xvWYBiJvrMgjdGSehorjKqbxtQVDESpev88hPJUyM6hYyGOq7KRBaHIyNjiEcl2hFkJjFIdQ0l3TQ8hx3tiEks/SQ2hwWFgX9yU7e02EJjMHjkko+yhdZciGUVCE2giZhcggrEs/SVsZGoz4KYNQPmFNGyHLd2MQyj9IXxmycAJXAEIX+ggZscUgIcCoSWMZBkf7AcIhwMBXI2FwajhAOAN4jEZCYxZFWIeIXegkNOkOgybc23pCOkOTJgSJzugkDNgaihAmCKyVkA4PU4QwMVKK0E0lirERHTulCGHmmgjCQ/emmEIkytcgjBAobwYjPHT/2SmnCkjn2ZCEQIF8n7Byc22nWUVXoqopSQgU594Q9gu3KG0+g7amBKFUGBjTb8LC3WMp3Qr6LjI4TBBCzYiuCWvum62Djw66EYQO0CNWhP3m3Aa6XWw5XEKoJ3iE7asFpwUi9D5vgxQWMI8QLMcSFcf3LACEyrZtFOcPx9c78+K5MkRiNhEnBPG6V0LFe4aJsUqoePvzplIoFCqVSmH8XAZ6XECE940TOlBPQAuDBvRK7+Howq32Dze+wFThnJvDIYR7YoCvZDxduLs1zFltvmCGCAG7PYhNCNUbBmVZt7XvOJ6n6pNfSe3LZwO0yuI9IkYoN2fIF7J3Lmg+z59bfBQbWrjV2jFk54nPJWKE0sF8tizjpxvgy/d/+pW0/FT1/IN7XveSQHh4HyN0wB6AqzS/aAf4vCI89nnK/6zMz24e0EVwmIRKUqDsY/eQAZjv+9bImk/fB1rTMzDEEYtQfkKGIft2yuLL9y99GPuyv+lAfoEh1hmEKkwpDzBfePiopGhR/bgMhogZU5/wb3hC+5gDWMuXPr5knVX8D6ZPMIiYMfUJ4ZNJNw0sqPazT2hfNbFPxjsgHSM2gPIJwVMR0aLGMjK1frUy9mNTqEj+GdogDjkWyfAJISYsCNn3u0G+vnuxfNrBgm/2Efmt5hVIPZ0xCE8gboypfOwG+SrLObLLWCofMpqUO1B5K4XcVVQnDELgtHyEDmlPpuYuz20qUdE6G9N/hgpEPR0wCOXvSqj0q0q9eb+5E/Q9kXFEFzXu0CUXgxDW0KAF3Qh3rxYsM4nsM9riugAxcjNICDJx6Kv8RhXh7gsvMGNfF8ivQhSiP434QQi89KB0QbbC5r+BYfGHAqU4lW+JvlOjiNB6IFtXLbSbs1/JAm//kjan/hzbByHsYmb7qE+8c+E4zFVB6F/CN6jdSA8V/ekZRYQWWUmJoAzr6w9kPXXnstWUQQiRZfIh2hWbziMKxb7DnVOvmsp6p37WiRpC64xoWM27qHZlPRD2NKrMo6WasPRK9IZ4yIIj64ao1q5szJ9BCNoO7Rei0rmLyPctPRPRHOlOX7WlsS+4wV+OrJ0KTihQ6uFiEEL2h8gg+or+UXT3hhaEbWq/SZoaRn8IGaZB54ShqT4JFEiJ+KO0XyX7fIZPA+mXUoRCVa5EdPr9S1nCoF8KObagc6JEMoZKhHGSdr4ZYwvI8WEiwqtDSELW+BBwjE8RirVDokOUrqWsMT5gnIYixGOH3J8gwpbuyloaVpwGMNZGETbvoqscmhPDLWnHlBVr+0vulrgownyVP/rdaDXDhv/iTK7HZ8ZLAWPeNKFAgik1uChEDUYixIx5A04B04T9ZVQ1RY+E05YfR5d6qJjzFoBuG02YL0TlXdik4334H5hLo2b+MECITxcyf0B6pfKmlDl/CDgHHCDMu+Htyl5SYR3ZzPBRjkXoyN0UU5Dw8L+whlWi5xmbks2QM48Pl4sRJMy3f/JTTa24lTpSnFwMOGPKIMxXjngJM9ZjnppnjAxcRYmTTwM3QmQR5itL9v4YpTk9kSo/hcjJiYLLa2MS5qtX54y5J/vsOz1TLL8+g5PXlnMk7+s/gEmYb7pvFpmih+ziXWAetXklHdOfcQgB80uZhF4xXtwuVlPAa1mlUnFZaAa+JN0K+fmlYLsKcQnztap7fzs/XxjG4vH6+WbaD36lHeniRYqbIwzWEPmEq0pYLVSa+Vq/UGkzUzVqpvxr5HiEjvSt3xVK+M7B/WT6IJ+iyM/VB11vkUzuG8D8L3+9BfCamQSqQmQphKyZgV73FB/wHiLhO2TdE/zatZiAdxDbgoWuXYNffxhHhSXIQrDQ9Ycq1pCKqjYFWgkWuoZUzTrgfNBvCaqdfwBKLQ1fB6xkLXdz2WQlsxNfcS8NoFT9iLXcitbjL46mYYxN92UOttwiYj2+mj0Vrsv2+Wv7O7uy1tqFuwe4xcKReyoo2RfDG++hkvn0Mq72SXet1my7zdc55GLoyH0xgPY2Ge/2+7vrf95/4/UMKbLs87PlTaXwvd3e9T5oVytu7eXXvAy7VjhybxOY/WnOL48wXW4ynDxI63x+/PbsXXz99XRdNLzBovzjcAnsTwNia1CJEF5IyLLK64tlJQtlBfYYyv4+82ES2icKcKGlBgVxlOzXpk2C+7VB57SnKRYN45qipZbqJbpv4hYXIhOGdXFLC5G947WSPWh1ic3CvLolxz6QirWP8BYdi+BrxEbhEILmRKcj3mF6SvZk16KYe7Ir3EJCkWLvq79tvlv8sxG27XwL/jksfMLPf0bJ5z9nZpvqacKzgv6A8562xXkLhEjFCT//uWvb4Z9KnZ23DU1R8vzD7McWZc+wzHyvKH8OacatDcRZstnu+EHOA/4DznT+/Ody/wFnq3sjKd0sLIWMmOIT5oa6cRjiRJ4SEmYv+MYLrSUmzFxFFauicQgzZm6EjExMwlwjO/3iQKSbiE+Yq3ey0RjNjkBHn4gwIz6qgC+anDALI43o0YQUof7xYuR4UJYw1xroZDQH4kY0KaHWxhizCSYl1Bdk5MzywhPmWlq6DbMTu4YmJtRiU+PaUEnCXGuULqPZEXZEgQjTnkLlToAqJMw1UjOqphPDDwUk9AaNqVRVc8Q5NT0FQq/jMFQzmkaSLgKO0GuOShlNg3nWdqqEudy+MkYAPhBCrxyRCkZTwoBiAiH0hhzgXo7ZkWx/GwER5nLdmQkHaZoz0VBapMAIc7n6XgcE0jQ7e3HCFBECJPTU2h9IQprmoJfUP2MLltDTQS95SXql1+tGPyKewAk9NSYOik3p/cCZSDhnXKkgXOlgz/EqrBim9z3k7IEX3m+pIlypcfrDGa3enwe6/mjk7J+qKLuNVBKuVW+cTnqzk8EaB5MxOJn1JqcNQKvJlnJCX/VGq9sdDofdbks9l68UCTXpi3D79UW4/foi3H59fsL/AdoJ8xzzJ1IvAAAAAElFTkSuQmCC"
  },
  "description": "",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "label4",
    "displayName": "\u003cstrong\u003eIntroduction\u003c/strong\u003e\u003cbr/\u003eThere are a lot of variables used for different events. We recommend to populate the variables as much as possible if you want to cover all of the data required for collection. For an up-to-date status of the required variables for each event, please check the \u003ca href\u003d\"https://documentation.bloomreach.com/discovery/docs/global-page-view-pixel\"\u003eofficial Bloomreach documentation\u003c/a\u003e. \u003cbr/\u003e\u003cbr/\u003e"
  },
  {
    "type": "TEXT",
    "name": "account_id",
    "displayName": "Account ID",
    "simpleValueType": true,
    "help": "acct_id",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "domain_key",
    "displayName": "Domain Key",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "version",
    "displayName": "Tracker version",
    "simpleValueType": true,
    "help": "This is the version of the tracker that is active. At time of writing it was 15.0. Leave empty for 15.0"
  },
  {
    "type": "TEXT",
    "name": "user_language",
    "displayName": "User Language",
    "simpleValueType": true,
    "help": "2 character option (ie nl, fr). By default set to user_language_navigator from event model"
  },
  {
    "type": "SELECT",
    "name": "type",
    "displayName": "Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "pageview",
        "displayValue": "pageview"
      },
      {
        "value": "event",
        "displayValue": "event"
      }
    ],
    "simpleValueType": true,
    "help": "type - required field. Either pageview or event are accepted values"
  },
  {
    "type": "SELECT",
    "name": "page_type",
    "displayName": "Page Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "homepage",
        "displayValue": "homepage"
      },
      {
        "value": "product",
        "displayValue": "product"
      },
      {
        "value": "category",
        "displayValue": "category"
      },
      {
        "value": "search",
        "displayValue": "search"
      },
      {
        "value": "conversion",
        "displayValue": "conversion"
      },
      {
        "value": "content",
        "displayValue": "content"
      },
      {
        "value": "thematic",
        "displayValue": "thematic"
      },
      {
        "value": "other",
        "displayValue": "other"
      }
    ],
    "simpleValueType": true,
    "help": "ptype - required for pageview events, optional for other events"
  },
  {
    "type": "SELECT",
    "name": "event_type",
    "displayName": "Event Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "click",
        "displayValue": "Suggest Event (click)"
      },
      {
        "value": "click-add",
        "displayValue": "Add-to-cart"
      },
      {
        "value": "quickview",
        "displayValue": "Quick View"
      },
      {
        "value": "submit",
        "displayValue": "Search Event (submit)"
      }
    ],
    "simpleValueType": true,
    "help": "etype - if you wish to use a lookup from a variable, use the following values: submit, quickview, click-add, click",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "event",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "catalogs",
    "displayName": "Catalogs",
    "simpleValueType": true,
    "help": "catalogs - This variable is used for search events and content pageview"
  },
  {
    "type": "GROUP",
    "name": "product",
    "displayName": "Product Data",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label2",
        "displayName": "These variables are required for page type \"product\" and all events besides search submit event. We use GA4 structure as a default (tick the box), custom values can also be included in other fields."
      },
      {
        "type": "CHECKBOX",
        "name": "prodidGa",
        "checkboxText": "Use the GA4 items array",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "product_id",
        "displayName": "Product ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "prodidGa",
            "paramValue": true,
            "type": "NOT_EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "product_name",
        "displayName": "Product Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "prodidGa",
            "paramValue": true,
            "type": "NOT_EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "product_sku",
        "displayName": "Product SKU",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "prodidGa",
            "paramValue": true,
            "type": "NOT_EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "search",
    "displayName": "Search variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label3",
        "displayName": "These parameters are required for search suggest event"
      },
      {
        "type": "TEXT",
        "name": "query",
        "displayName": "Query",
        "simpleValueType": true,
        "help": "q"
      },
      {
        "type": "TEXT",
        "name": "actual_query",
        "displayName": "Actual Query",
        "simpleValueType": true,
        "help": "aq"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "event",
        "type": "EQUALS"
      },
      {
        "paramName": "event_type",
        "paramValue": "suggest",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "content",
    "displayName": "Content Page Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "content_id",
        "displayName": "Content ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "content_name",
        "displayName": "Content Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "categoryPage",
    "displayName": "Category Page Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "category_id",
        "displayName": "Category ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "category_name",
        "displayName": "Category Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionPage",
    "displayName": "Conversion Page Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label1",
        "displayName": "\u003cstrong\u003eImportant: \u003c/strong\u003e Currently, the standard GA4 items object is used to populate the basket parameter. \u003cbr/\u003e\u003cbr/\u003e"
      },
      {
        "type": "TEXT",
        "name": "basket_value",
        "displayName": "Basket Value",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "transaction_id",
        "displayName": "Transaction ID",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "development",
    "displayName": "Debugging options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "activateLogs",
        "checkboxText": "Activate logs",
        "simpleValueType": true
      },
      {
        "type": "SELECT",
        "name": "debug",
        "displayName": "Bloomreach Debug Mode",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "Set it to true to not have test data included in production, but you will use the event diagnostics feature",
        "defaultValue": false
      },
      {
        "type": "SELECT",
        "name": "test_data",
        "displayName": "Bloomreach Test Data",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "Set it to true to not have test data included in production",
        "defaultValue": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// open the API gates
const encodeUriComponent = require('encodeUriComponent');
const decodeUriComponent = require('decodeUriComponent');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const queryPermission = require('queryPermission');
const sendHttpGet = require('sendHttpGet');
const getTimestampMillis = require('getTimestampMillis');
const generateRandom = require('generateRandom');
const makeNumber = require('makeNumber');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const parseUrl = require('parseUrl');
const getEventData = require('getEventData');
const makeInteger = require('makeInteger');
const getType = require('getType');
const activateLogs = data.activateLogs;

// function to check if value is empty
function isNotEmpty(obj) {
  if(obj == undefined || obj == null || obj.toString() == "" ) {
    return false;
  } else {
    return obj;
  }
}

// we work on the cookie part of the code
// we get the uid to keep it for existing cookies and hc (hit count) parameter to increment with 1 and update the cookie
const page_location = parseUrl(getEventData('page_location'));
const cookieDomain = page_location.hostname.indexOf('www.') == 0 ? page_location.hostname.replace('www.', '.') : page_location.hostname;


let cookieValue = getCookieValues('_br_uid_2');
const timestampSeconds = makeInteger(getTimestampMillis() / 1000);

function incrementHcValue(cookie2) {
    // Check if the value is not an array, get the string value instead
    if (getType(cookie2) === 'array') {
        cookie2 = cookie2[0];
    }

    // Decode cookie2 value
    var decoded = decodeUriComponent(cookie2);

    // Function to pull value from parameter
    function getParameterValue(decoded, paramName) {
        var paramIndex = decoded.indexOf(paramName + "=");
        if (paramIndex === -1) {
            return null;
        }

        var start = paramIndex + paramName.length + 1; // after the "=" character
        var end = decoded.indexOf(":", start);
        if (end === -1) {
            end = decoded.length;
        }

        var value = decoded.substring(start, end);
        return value;
    }

    // pull uid and hc paramater values
    var uidValue = getParameterValue(decoded, "uid");
    var hcValue = makeInteger(getParameterValue(decoded, "hc"), 10);

    // Check if uid and hc are correct parameters
    if (!uidValue) {
        if(activateLogs){logToConsole("invalid uid-value");}
    }

    if (!hcValue) {
        if(activateLogs){logToConsole("invalid hc-value");}
    }

    // increment the value with one to update hit count
    var newHcValue = hcValue + 1;
   
    return {
        uid: uidValue,
        newHcValue: newHcValue
    };
}

const options = {
    'domain': cookieDomain, 
    'path': '/',
    'max-age': 60*60*24*365,
    'secure': true
};

if(isNotEmpty(cookieValue)){
  const cookieValues = incrementHcValue(cookieValue);
  const h2_new = cookieValues.newHcValue;
  const uid_current = cookieValues.uid;  
  setCookie('_br_uid_2', "uid=" + uid_current + ":v=15.0:ts=" + timestampSeconds + ":hc=" + h2_new,  options);
}else if(!isNotEmpty(cookieValue)){
  setCookie('_br_uid_2', "uid=" + generateRandom(100000000000, 9999999999999) + ":v=15.0:ts=" + timestampSeconds + ":hc=1", options);
  cookieValue = "uid=" + generateRandom(100000000000, 9999999999999) + ":v=15.0:ts=" + timestampSeconds + ":hc=1"; 
  if(activateLogs){logToConsole('Cookie is empty... Created a new cookie value' + cookieValue);}
}

// generate random number
let random_number = generateRandom(100000000000, 9999999999999);

// check the items object in GA4 format
let items_data;
if(isNotEmpty(getEventData('items'))){
  items_data = getEventData('items');
}

let items_name = () => {  
  let result = "";
  if(isNotEmpty(data.items)){
    items_data = data.items;
  }
  if(data.prodidGa) {
    if (items_data) {
      items_data.forEach(function(item, i) {
        let name = item.item_name || '';
        name = name.split('!').join('');        
        result += name;
        if (i < items_data.length - 1) {
          result += ',';
        }   
      });
    }
  }
  return result;
};

let items_id = () => {  
  let result = "";
  if(isNotEmpty(data.items)){
    items_data = data.items;
  }
  if(data.prodidGa) {
    if (items_data) {
      items_data.forEach(function(item, i) {
        result += item.item_id;
        if (i < items_data.length - 1) {
          result += ',';
        }   
      });
    }
  }
  return result;
};

// create the basket parameter from the GA4 items object on the purchase event
function generateBasketParameter(items) {
    return items.map(item => {
        const productId = item.item_id;
        const skuId = item.item_id; // product ID is identical
        const productName = encodeUriComponent(item.item_name ? item.item_name.split('!').join('') : '');
        const price = makeNumber(item.price); // price with decimals
        const quantity = item.quantity; // Number of products

        // Format product by product in this function
        return "!iSKU_" + productId + "'sSKU_" + skuId + "'n" + productName + "'p" + price + "'q" + quantity;
    }).join('');
}

let event_group = undefined;
  if(data.event_type === 'click-add'){
     event_group = 'cart';
   }else if(data.event_type === 'click' || data.event_type === 'submit'){
     event_group = 'suggest';
   }else if(data.event_type === 'quickview'){
     event_group = 'product';
   }

let params = {};
// required variables
params.acct_id = data.account_id;
params.debug = data.debug;
params.test_data = data.test_data;
params.version = data.version || '15.0';
//params.tzo = '-120'; // how do we set this up? Is it required?
params.cookie2 = cookieValue;
params.sid = 'undefined';
params.origin_source = 'gtmss';
params.domain_key = data.domain_key; 
params.rand = random_number;
params.type = data.type; 
params.lang = isNotEmpty(data.user_language) || getEventData('user_language_navigator');
params.title = isNotEmpty(data.page_title) || getEventData('page_title');
params.url = isNotEmpty(data.page_location) || getEventData('page_location');
params.ref = isNotEmpty(data.referrer) || getEventData('page_referrer') || 'https://www' + cookieDomain;
params.orig_ref_url = isNotEmpty(data.referrer) || getEventData('page_referrer') || 'https://www' + cookieDomain;
params.ptype = data.page_type || 'other';
if(params.type == 'event'){
  params.etype = data.event_type;
  params.group = event_group;
}
params.prod_id = items_id() || getEventData('items[0].item_id');
params.prod_name = items_name() || getEventData('items[0].item_name');
params.sku = items_id() || getEventData('items[0].item_id');
params.e_sku = items_id() || getEventData('items[0].item_id');
params.e_prod_id = items_id() || getEventData('items[0].item_id');
if(params.group == 'suggest'){
  params.q = data.query || getEventData('search_term'); 
  params.aq = data.actual_query || getEventData('search_term'); 
}
if(params.ptype == 'content'){
  params.content_id = data.content_id || getEventData('content_id');
  params.content_name = data.content_name || getEventData('content_name');
  params.catalogs = 'cat0=' + data.catalogs;
}
if(params.ptype == 'search'){
  params.search_term = data.search_term || getEventData('search_term');  
  params.catalogs = 'cat0=' + data.catalogs;
}
if(params.ptype == 'category'){
  params.cat_id = data.category_id;
  params.cat = data.category_name;
}
if(params.ptype == 'conversion'){
  params.is_conversion = data.is_conversion;
  params.order_id = data.transaction_id || getEventData('transaction_id');
  params.basket_value = data.basket_value|| getEventData('value');
  params.basket = generateBasketParameter(items_data);
}

// check the logs if the box is ticked
if (data.activateLogs) {
  logToConsole("Params: " + JSON.stringify(params));  
}

// generating the pixel for events
let url = 'https://p-eu.brsrvr.com/pix.gif?';

let all_params = "";
if (isNotEmpty(params)) {
  for (var key in params) {
    if (params[key] == undefined || params[key] == null) {
      continue;
    }
    all_params += key + "=" + encodeUriComponent(params[key]) + "&";
  }
  // Remove the last '&' if it exists
  if (all_params.length > 0 && all_params[all_params.length - 1] === "&") {
    all_params = all_params.slice(0, -1);
  }
  url += all_params;
}
if (data.activateLogs) {
  if(activateLogs){logToConsole('URL: ' + url);}
}

// send to server
return sendHttpGet(url, {
  headers: {
      'content-type': 'image/gif', 
      'user-agent': getEventData('user_agent'), 
      'referrer': getEventData('page_location'), 
      'Accept-Encoding': 'gzip, deflate, br, zstd',
      //'X-Forwarded-For': getEventData('ip_override'),
      'Host': 'p-eu.brsrvr.com'
  },
  timeout: 15000,
}).then((result) => {
  if (result.statusCode >= 200 && result.statusCode < 300) {
    if(activateLogs){logToConsole('Bloomreach Result: Success');}
    data.gtmOnSuccess();
  } else {
    if(activateLogs){logToConsole('Bloomreach Error: ' + result.statusCode);}
    data.gtmOnFailure();
  }
});


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_br_uid_2"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://p.brsrvr.com/*"
              },
              {
                "type": 1,
                "string": "https://p-eu.brsrvr.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_br_uid_2"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 7/22/2025, 9:45:14 AM
